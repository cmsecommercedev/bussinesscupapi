@model BussinessCupApi.Models.RichStaticContent
@{
	ViewData["Title"] = "Rich Static Content";
	Layout = "_AdminLayout";

	var items = ViewBag.Items as System.Collections.Generic.List<BussinessCupApi.Models.RichStaticContent>;
	var categories = ViewBag.Categories as System.Collections.Generic.List<BussinessCupApi.Models.RichContentCategory>;
}

<div class="max-w-6xl mx-auto p-6">
	<h2 class="text-2xl font-bold text-gray-200 mb-6">Rich Static Content</h2>

	@if (TempData["SuccessMessage"] != null)
	{
		<div class="mb-4 p-3 rounded-lg text-sm bg-green-600 text-white">@TempData["SuccessMessage"]</div>
	}

	<form asp-action="RichStatic" method="post" enctype="multipart/form-data" class="mb-6" id="richStaticForm"
		onsubmit="return handleRichStaticSubmit(this);">
		@Html.AntiForgeryToken()
		<div class="grid grid-cols-1 md:grid-cols-12 gap-4">
			<div class="md:col-span-3">
				<label class="block text-gray-300 mb-1">Category</label>
				<select asp-for="CategoryId" required
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500">
					<option value="">-- seçin --</option>
					@if (categories != null)
					{
						@foreach (var cat in categories)
						{
							<option value="@cat.Id" selected="@(Model?.CategoryId == cat.Id ? "selected" : null)">@cat.Name</option>
						}
					}
				</select>
				<span asp-validation-for="CategoryId" class="text-sm text-red-400"></span>
			</div>
			<div class="md:col-span-2">
				<label class="block text-gray-300 mb-1">Culture</label>
				<select asp-for="Culture"
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500">
					<option value="tr">tr</option>
				</select>
			</div>

			<div class="md:col-span-2">
				<label class="block text-gray-300 mb-1">Season (optional)</label>
				<select asp-for="SeasonId"
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500">
					<option value="">-- seçin --</option>
					@if (ViewBag.Seasons != null)
					{
						@foreach (var season in ViewBag.Seasons as System.Collections.Generic.List<BussinessCupApi.Models.Season>)
						{
							<option value="@season.SeasonID" selected="@(Model?.SeasonId == season.SeasonID ? "selected" : null)">@season.Name</option>
						}
					}
				</select>
			</div>

			<div class="md:col-span-3">
				<label class="block text-gray-300 mb-1">Media Upload</label>
				<input asp-for="MediaFile" type="file" accept="image/*,video/mp4"
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
				@if (!string.IsNullOrWhiteSpace(Model?.MediaUrl))
				{
					<div class="mt-2 text-xs text-gray-400 break-all">
						<span>Current:</span>
						<a href="@Model.MediaUrl" target="_blank"
							class="text-yellow-400 hover:underline">@Model.MediaUrl</a>
					</div>
					<input type="hidden" asp-for="MediaUrl" />
				}
			</div>

			<div class="md:col-span-3">
				<label class="block text-gray-300 mb-1">Profile Image (Video Preview)</label>
				<input asp-for="ProfileImageFile" type="file" accept="image/*"
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
				<p class="text-xs text-gray-400 mt-1">Videoların önizleme resimleri için kullanılır</p>
				@if (!string.IsNullOrWhiteSpace(Model?.ProfileImageUrl))
				{
					<div class="mt-2 text-xs text-gray-400 break-all">
						<span>Current:</span>
						<a href="@Model.ProfileImageUrl" target="_blank"
							class="text-yellow-400 hover:underline">@Model.ProfileImageUrl</a>
					</div>
					<input type="hidden" asp-for="ProfileImageUrl" />
				}
			</div>

			<div class="md:col-span-4">
				<label class="block text-gray-300 mb-1">Video Url (optional) (Embed Youtube Link)</label>
				<input asp-for="EmbedVideoUrl"
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500"
					placeholder="https://..." />
			</div>

			<div class="md:col-span-12">
				<label class="block text-gray-300 mb-1">Text</label>
				<textarea asp-for="Text" rows="6"
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500"></textarea>
			</div>

			<div class="md:col-span-6">
				<label class="block text-gray-300 mb-1">Alt Text (optional)</label>
				<input asp-for="AltText"
					class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
			</div>

			<div class="md:col-span-2 flex items-end">
				<label class="inline-flex items-center gap-2 text-gray-300">
					<input asp-for="Published" type="checkbox"
						class="h-4 w-4 text-yellow-500 bg-gray-900 border-gray-600 rounded focus:ring-yellow-500" />
					<span>Published</span>
				</label>
			</div>

			<div class="md:col-span-2 md:col-start-11 flex items-end">
				<button id="saveBtn" type="submit"
					class="w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-semibold rounded-lg shadow transition">
					<span class="inline-flex items-center gap-2">
						<svg id="saveSpinner" class="hidden animate-spin h-4 w-4 text-gray-900" viewBox="0 0 24 24"
							fill="none">
							<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
							</circle>
							<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4A4 4 0 008 12H4z"></path>
						</svg>
						<span id="saveBtnText">Kaydet</span>
					</span>
				</button>
			</div>
		</div>
	</form>

	<h4 class="text-xl font-semibold text-gray-200 mb-3">Mevcut Kayıtlar</h4>

	@foreach (var grp in (items ?? new System.Collections.Generic.List<BussinessCupApi.Models.RichStaticContent>())
		.GroupBy(x => x.Category?.Name ?? "No Category")
		.OrderBy(g => g.Key))
	{
		<div class="mb-6">
			<div class="px-6 py-2 bg-gray-700 text-gray-100 rounded-t-lg font-semibold">@grp.Key</div>
			<div class="overflow-x-auto bg-gray-800 shadow-md rounded-b-lg">
				<table class="min-w-full text-sm text-left text-gray-300 align-top">
					<thead class="bg-gray-700 text-gray-200">
						<tr>
							<th class="px-6 py-3">Culture</th>
							<th class="px-6 py-3">Season</th>
							<th class="px-6 py-3">Image</th>
							<th class="px-6 py-3">Profile Image</th>
							<th class="px-6 py-3">Video</th>
							<th class="px-6 py-3">Text</th>
							<th class="px-6 py-3">Alt</th>
							<th class="px-6 py-3">Published</th>
							<th class="px-6 py-3">Updated</th>
							<th class="px-6 py-3 text-right">İşlem</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var x in grp.OrderByDescending(x => x.UpdatedAt))
						{
							<tr class="border-b border-gray-700 hover:bg-gray-700/40">
								<td class="px-6 py-3">@x.Culture</td>
								<td class="px-6 py-3">@(x.Season?.Name ?? "-")</td>
								<td class="px-6 py-3">
									@if (!string.IsNullOrWhiteSpace(x.MediaUrl))
									{
										if (x.MediaUrl.EndsWith(".mp4", StringComparison.OrdinalIgnoreCase))
										{
											<a href="@x.MediaUrl" target="_blank" class="inline-block">
												<img src="/images/defaultvideo.png" alt="Video"
													class="h-10 w-10 object-cover rounded border border-gray-600" />
											</a>
										}
										else
										{
											<a href="@x.MediaUrl" target="_blank" class="inline-block">
												<img src="@x.MediaUrl" alt="@x.AltText"
													class="h-10 w-10 object-cover rounded border border-gray-600" />
											</a>
										}
									}
									else
									{
										<span class="text-gray-500">-</span>
									}
								</td>
								<td class="px-6 py-3">
									@if (!string.IsNullOrWhiteSpace(x.ProfileImageUrl))
									{
										<a href="@x.ProfileImageUrl" target="_blank" class="inline-block">
											<img src="@x.ProfileImageUrl" alt="Profile Image"
												class="h-10 w-10 object-cover rounded border border-gray-600" />
										</a>
									}
									else
									{
										<span class="text-gray-500">-</span>
									}
								</td>
								<td class="px-6 py-3 truncate max-w-[220px]">@x.EmbedVideoUrl</td>
								<td class="px-6 py-3 whitespace-pre-line max-w-[420px]">@x.Text</td>
								<td class="px-6 py-3 whitespace-pre-line max-w-[260px]">@x.AltText</td>
								<td class="px-6 py-3">@(x.Published ? "Yes" : "No")</td>
								<td class="px-6 py-3">@x.UpdatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
								<td class="px-6 py-3">
									<div class="flex gap-2 justify-end">
										<form asp-action="DeleteRichStatic" method="post"
											onsubmit="return confirm('Silinsin mi?')">
											@Html.AntiForgeryToken()
											<input type="hidden" name="id" value="@x.Id" />
											<button type="submit"
												class="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded-lg transition">Sil</button>
										</form>
									</div>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		</div>
	}
</div>
@section Scripts {
	<script>
		function loadToForm(categoryId, culture, imageUrl, videoUrl, text, altText, published) {
			var sel = document.getElementById('CategoryId');
			sel.value = categoryId || '';

			document.getElementById('Culture').value = culture || 'tr';
			if (document.getElementById('ImageUrl')) {
				document.getElementById('ImageUrl').value = imageUrl || '';
			}
			document.getElementById('VideoUrl').value = videoUrl || '';
			document.getElementById('Text').value = text || '';
			document.getElementById('AltText').value = altText || '';
			document.getElementById('Published').checked = !!published;
		}

		var richStaticSubmitting = false;

		function handleRichStaticSubmit(form) {
			if (richStaticSubmitting) return false; // ikinci kez gönderimi engelle
			richStaticSubmitting = true;

			var btn = document.getElementById('saveBtn');
			if (btn) {
				btn.disabled = true;
				btn.classList.add('opacity-60', 'cursor-not-allowed');

				var spinner = document.getElementById('saveSpinner');
				if (spinner) spinner.classList.remove('hidden');

				var txt = document.getElementById('saveBtnText');
				if (txt) txt.textContent = 'Kaydediliyor...';
			}

			return true; // form gönderimine izin ver
		}
	</script>
}