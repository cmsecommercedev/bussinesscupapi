@model BussinessCupApi.Models.MatchNews // Form için model tipi
@using BussinessCupApi.Models 
@using Microsoft.AspNetCore.Http 

@{
    ViewData["Title"] = "Maç Haberleri";
    
    if (User.IsInRole("Admin"))
    {
        Layout = "_AdminLayout";
    }
    else if (User.IsInRole("CityAdmin"))
    {
        Layout = "_CityAdminLayout";
    }
    var matchNewsList = ViewBag.MatchNewsList as List<MatchNews> ?? new List<MatchNews>();
}

@* Font Awesome ikonları için (kullanılacaksa) *@
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<div class="container mx-auto px-4 py-8">

    @* Başarı/Hata Mesajları *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">@TempData["SuccessMessage"]</span>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">@TempData["ErrorMessage"]</span>
        </div>
    }
    @if (TempData["InfoMessage"] != null)
    {
        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">@TempData["InfoMessage"]</span>
        </div>
    }


    @* --- Yeni Haber Ekleme Formu --- *@
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-yellow-500 mb-6">Haber Ekle</h2>

        <form asp-action="Create" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-red-500 text-sm mb-4"></div>

            <div class="mb-6">
                <label for="MainPhoto" class="block text-sm font-medium text-gray-300 mb-1">Başlık Resmi</label>
                <input type="file" id="MainPhoto" name="MainPhoto" accept="image/*"
                       class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4
                              file:rounded-md file:border-0 file:text-sm file:font-semibold
                              file:bg-yellow-500 file:text-gray-900 hover:file:bg-yellow-600
                              cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-yellow-500">
                <p class="mt-1 text-xs text-gray-500">Başlık resmi için tek bir resim seçebilirsiniz. İzin verilen formatlar: JPG, PNG, GIF vb.</p>
            </div>

            <div class="mb-6">
                <label for="ImageFiles" class="block text-sm font-medium text-gray-300 mb-1">Haber Resimleri</label>
                <input type="file" id="ImageFiles" name="ImageFiles" accept="image/*" multiple
                       class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4
                              file:rounded-md file:border-0 file:text-sm file:font-semibold
                              file:bg-yellow-500 file:text-gray-900 hover:file:bg-yellow-600
                              cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-yellow-500">
                <p class="mt-1 text-xs text-gray-500">Birden fazla resim seçebilirsiniz. İzin verilen formatlar: JPG, PNG, GIF vb.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label asp-for="Title" class="block text-sm font-medium text-gray-300 mb-1">Başlık</label>
                    <input asp-for="Title" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500" />
                    <span asp-validation-for="Title" class="text-red-500 text-xs mt-1"></span>
                </div>
                <div>
                    <label asp-for="Subtitle" class="block text-sm font-medium text-gray-300 mb-1">Alt Başlık</label>
                    <input asp-for="Subtitle" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500" />
                    <span asp-validation-for="Subtitle" class="text-red-500 text-xs mt-1"></span>
                </div>
                <div>
                    <label asp-for="DetailsTitle" class="block text-sm font-medium text-gray-300 mb-1">Detay Başlığı</label>
                    <input asp-for="DetailsTitle" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500" />
                    <span asp-validation-for="DetailsTitle" class="text-red-500 text-xs mt-1"></span>
                </div>
            </div>

            <div class="mb-6">
                <label asp-for="Details" class="block text-sm font-medium text-gray-300 mb-1">Detaylar</label>
                <textarea asp-for="Details" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500" rows="5"></textarea>
                <span asp-validation-for="Details" class="text-red-500 text-xs mt-1"></span>
            </div>
            @{
                bool isCityAdmin = ViewBag.IsCityAdmin ?? false;
                int? userCityId = ViewBag.UserCityID;
            }
            @if (!isCityAdmin)
            {
                <div class="form-group mb-3 flex items-center">
                    <input asp-for="IsMainNews" type="checkbox" class="mr-2 accent-yellow-500 scale-125" id="IsMainNews" />
                    <label asp-for="IsMainNews" class="text-lg font-bold text-yellow-400 mb-1 flex items-center">
                        <i class="fas fa-star mr-1"></i> Ana Haber
                    </label>
                    <span asp-validation-for="IsMainNews" class="text-danger"></span>
                </div>
            }
            else
            {
                <input type="hidden" asp-for="IsMainNews" value="false" />
            }

            <div id="city-team-fields">
                @if (!isCityAdmin)
                {
                    <div class="form-group mb-3">
                        <label asp-for="CityID" class="block text-sm font-medium text-gray-300 mb-1">Şehir</label>
                        <select asp-for="CityID" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" asp-items="@(new SelectList(ViewBag.Cities, "CityID", "Name", Model.CityID))">
                            <option value="">Şehir Seçiniz</option>
                        </select>
                        <span asp-validation-for="CityID" class="text-danger"></span>
                    </div>
                }
                else
                {
                    <input type="hidden" asp-for="CityID" value="@userCityId" />
                }
                <div class="form-group mb-3">
                    <label asp-for="TeamID" class="block text-sm font-medium text-gray-300 mb-1">Takım</label>
              <select asp-for="TeamID" id="TeamID" name="TeamID" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
    <option value="">Takım Seçiniz</option>
    @* Diğer seçenekler JS ile eklenecek *@
</select>
                    <span asp-validation-for="TeamID" class="text-danger"></span>
                </div>
            </div>

            <div>
                <button type="submit"
                        class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded transition-colors">
                    <i class="fas fa-plus mr-1"></i> Haberi Ekle
                </button>
            </div>
        </form>
    </div>

    @* --- Mevcut Haberler Tablosu --- *@
    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <h2 class="text-2xl font-bold text-yellow-500 p-6">Mevcut Haberler</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Görsel</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Başlık</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Alt Başlık</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Oluşturulma Tarihi</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Durum</th>
                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">İşlemler</span></th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
                    @if (!matchNewsList.Any())
                    {
                        <tr>
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-400">
                                @* <<< Colspan 6'ya güncellendi *@
                                Henüz hiç haber eklenmemiş.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in matchNewsList)
                        {
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                    <div class="flex space-x-2">
                                        @if (item.MatchNewsMainPhoto != null)
                                        {
                                            <img src="@Url.Content(item.MatchNewsMainPhoto)"
                                                 alt="Haber Resmi" class="h-12 w-auto object-contain rounded" title="Haber Resmi" />
                                        }
                                        else
                                        {
                                            <span class="text-gray-500 text-xs">Resim Yok</span>
                                        }
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                                    <span title="@item.Title">
                                        @(item.Title?.Length > 20 ? item.Title.Substring(0, 20) + "..." : item.Title)
                                    </span>
                                </td> 
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                        @(item.Subtitle?.Length > 20 ? item.Subtitle.Substring(0, 20) + "..." : item.Subtitle)
                                </td>                                 
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                    @item.CreatedDate.ToString("g") @* Kısa tarih ve saat formatı *@
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    @if (item.Published)
                                    {
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Yayında</span>
                                    }
                                    else
                                    {
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Yayında Değil</span>
                                    }
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                    @* --- Aktif Edilen Butonlar --- *@
                                    <a asp-action="Edit" asp-route-id="@item.Id" class="text-yellow-500 hover:text-yellow-600" title="Düzenle"><i class="fas fa-edit"></i></a>
                                    <a asp-action="Details" asp-route-id="@item.Id" class="text-blue-400 hover:text-blue-300" title="Detaylar"><i class="fas fa-info-circle"></i></a>
                                    <form asp-action="TogglePublish" asp-route-id="@item.Id" method="post" class="inline">
                                        @Html.AntiForgeryToken()
                                        @if (item.Published)
                                        {
                                            <button type="submit" class="text-red-500 hover:text-red-400" title="Yayından Kaldır">
                                                <i class="fas fa-eye-slash"></i> @* Veya fas fa-toggle-off *@
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="submit" class="text-green-500 hover:text-green-400" title="Yayınla">
                                                <i class="fas fa-eye"></i> @* Veya fas fa-toggle-on *@
                                            </button>
                                        }
                                    </form>
                                    @* İsterseniz Sil butonu da ayrı olarak eklenebilir *@
                                    @*
                            <form asp-action="Delete" asp-route-id="@item.Id" method="post" class="inline" onsubmit="return confirm('Bu haberi KALICI olarak silmek istediğinizden emin misiniz?');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="text-gray-400 hover:text-red-600" title="Kalıcı Olarak Sil"><i class="fas fa-trash"></i></button>
                            </form>
                            *@
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        function toggleCityTeamFields() {
            var isMain = document.getElementById('IsMainNews').checked;
            document.getElementById('city-team-fields').style.display = isMain ? 'none' : 'block';
        }
        document.getElementById('IsMainNews').addEventListener('change', toggleCityTeamFields);
        toggleCityTeamFields();

        // Şehir değişince takımları getir
        document.getElementById('CityID').addEventListener('change', function () {
            var cityId = this.value;
            var teamSelect = document.getElementById('TeamID');
            teamSelect.innerHTML = '<option value="">Takım Seçiniz</option>';
            if (cityId) {
                fetch('/MatchNews/GetTeamsByCity?cityId=' + cityId)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(function (team) {
                            var opt = document.createElement('option');
                            opt.value = team.teamID;
                            opt.text = team.name;
                            teamSelect.appendChild(opt);
                        });
                    });
            }
        });
    </script>
}