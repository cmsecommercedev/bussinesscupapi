@{
	Layout = "_AdminLayout";
	ViewData["Title"] = "Fotoğraf Galerisi Yönetimi";
}

<div class="max-w-4xl mx-auto mt-10 space-y-6">

	<!-- Kategori Kartı -->
	<div class="bg-gray-800 text-white shadow-lg rounded-2xl p-6">
		<h2 class="text-xl font-bold mb-4">Kategori Seç</h2>
		<select id="categorySelect"
			class="w-full bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-white">
			<option value="">Seçiniz</option>
			@foreach (var y in (string[])ViewBag.AllowedYears)
			{
				<option value="@y">@y</option>
			}
		</select>
	</div>

	<!-- Fotoğraf Ekleme Kartı -->
	<div class="bg-gray-800 text-white shadow-lg rounded-2xl p-6">
		<h2 class="text-xl font-bold mb-4">Yeni Fotoğraf Ekle</h2>
		<form id="photoForm" asp-action="Create" asp-controller="PhotoGallery" method="post"
			enctype="multipart/form-data" class="space-y-4">
			<input type="hidden" id="selectedCategory" name="year" />

			<div
				class="border-2 border-dashed border-gray-600 rounded-lg p-4 hover:border-yellow-500 transition-colors flex items-start gap-4">
				<!-- Upload Alanı -->
				<div class="flex flex-col items-center text-center">
					<i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
					<label for="photos" class="cursor-pointer">
						<span class="text-yellow-500 hover:text-yellow-400">Fotoğraf seçin</span>
					</label>
					<input type="file" name="photos" id="photos" multiple class="hidden" accept="image/*"
						onchange="previewImages(event)">
					<p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF maksimum 10MB</p>
				</div>

				<!-- Preview -->
				<div id="photoPreview" class="hidden flex flex-wrap gap-2"></div>
			</div>


			<button type="submit"
				class="w-full px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow-md transition">Kaydet</button>
		</form>
	</div>

	<!-- Fotoğraf Listesi Kartı -->
	<div class="bg-gray-800 text-white shadow-lg rounded-2xl p-6">
		<h2 class="text-xl font-bold mb-4">Kategori Fotoğrafları</h2>
		<div id="photoList" class="grid grid-cols-2 md:grid-cols-4 gap-4">
			<p class="text-gray-400">Bir kategori seçiniz...</p>
		</div>
	</div>

</div>

@section Scripts {
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		// Preview
		function previewImages(event) {
    const previewContainer = document.getElementById("photoPreview");
    previewContainer.innerHTML = "";
    previewContainer.classList.remove("hidden");

    Array.from(event.target.files).forEach(file => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.classList.add("w-24","h-24","object-cover","rounded-md","border","border-gray-500");
        previewContainer.appendChild(img);
    });
}



		// Kategori seçildiğinde fotoğrafları yükle
		$("#categorySelect").on("change", function () {
			var year = $(this).val();
			$("#selectedCategory").val(year);

			if (year) {
				$.get("@Url.Action("GetPhotos", "PhotoGallery")", { year: year }, function (data) {
					var list = $("#photoList");
					list.empty();

					if (data.length === 0) {
						list.append('<p class="text-gray-400">Bu kategoride fotoğraf yok.</p>');
					} else {
						data.forEach(function (photo) {
							list.append(`
	                                <div class="relative group bg-gray-700 shadow-md rounded-xl overflow-hidden">
	                                    <img src="${photo.url}" class="w-full h-32 object-cover" />
	                                    <button type="button"
	                                            data-url="@Url.Action("Delete", "PhotoGallery")?path=${photo.path}&year=${year}"
	                                            class="absolute top-2 right-2 bg-red-600 text-white px-2 py-1 rounded-lg text-sm opacity-0 group-hover:opacity-100 transition">
	                                        Sil
	                                    </button>
	                                </div>
	                            `);
						});
					}
				});
			} else {
				$("#photoList").html('<p class="text-gray-400">Bir kategori seçiniz...</p>');
			}
		});

		// Fotoğraf Silme
		$(document).on("click", "button[data-url]", function () {
			var btn = $(this);
			var url = btn.data("url");

			if (confirm("Bu fotoğrafı silmek istediğinize emin misiniz?")) {
				$.post(url, function () {
					btn.closest(".group").fadeOut(500, function () { $(this).remove(); });
				}).fail(function () {
					alert("Silme işlemi sırasında hata oluştu.");
				});
			}
		});

		// Fotoğraf Ekleme sonrası listeyi güncelle
		$("#photoForm").on("submit", function (e) {
			e.preventDefault();
			var formData = new FormData(this);

			$.ajax({
				url: $(this).attr("action"),
				type: "POST",
				data: formData,
				processData: false,
				contentType: false,
				success: function () {
					alert("Fotoğraf eklendi.");
					$("#categorySelect").trigger("change"); // listeyi yenile
				},
				error: function () {
					alert("Fotoğraf eklenirken hata oluştu.");
				}
			});
		});
	</script>
}
